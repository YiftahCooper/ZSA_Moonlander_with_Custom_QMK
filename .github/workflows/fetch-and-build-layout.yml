name: Fetch and build layout

on:
  workflow_dispatch:
    inputs:
      layout_id:
        description: "Layout id available in URL https://configure.zsa.io/voyager/layouts/[ID_IS_HERE]/latest"
        required: true
        default: "3aMQz"
      layout_geometry:
        description: "Keyboard type"
        type: choice
        options:
          - moonlander
          - moonlander/reva
          - moonlander/revb
          - planck_ez
          - planck_ez/glow
        default: moonlander

permissions:
  contents: write

jobs:
  fetch-and-build-layout:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          ref: oryx
          fetch-depth: 0

      - name: Download layout source
        id: download-layout-source
        run: |
          GEOMETRY="${{ github.event.inputs.layout_geometry }}"
          echo "Fetching layout for Geometry: $GEOMETRY"
          
          QUERY='query getLayout($hashId: String!, $revisionId: String!, $geometry: String!) { layout(hashId: $hashId, revisionId: $revisionId, geometry: $geometry) { revision { hashId, qmkVersion, changeDescription } } }'
          VARIABLES="{\"hashId\":\"${{ github.event.inputs.layout_id }}\",\"revisionId\":\"latest\",\"geometry\":\"$GEOMETRY\"}"
          
          PAYLOAD=$(jq -n --arg q "$QUERY" --arg v "$VARIABLES" '{query: $q, variables: $v|fromjson}')
          
          curl --location --silent --show-error 'https://oryx.zsa.io/graphql' \
            --header 'Content-Type: application/json' \
            --data "$PAYLOAD" > response.json
            
          HASH_ID=$(jq -r '.data.layout.revision.hashId' response.json)
          FIRMWARE_VERSION=$(jq -r '.data.layout.revision.qmkVersion' response.json)
          CHANGE_DESC=$(jq -r '.data.layout.revision.changeDescription // "Manual build"' response.json)

          if [ "$HASH_ID" == "null" ] || [ -z "$HASH_ID" ]; then
            echo "::error::Failed to retrieve Hash ID from Oryx response."
            exit 1
          fi

          echo "Found Hash ID: $HASH_ID"
          echo "Firmware Version: $FIRMWARE_VERSION"
          
          echo "firmware_version=$FIRMWARE_VERSION" >> "$GITHUB_OUTPUT"
          echo "change_description=$CHANGE_DESC" >> "$GITHUB_OUTPUT"

          curl -L "https://oryx.zsa.io/source/$HASH_ID" -o source.zip

      - name: Unzip source
        run: |
          unzip -oj source.zip '*_source/*' -d ${{ github.event.inputs.layout_id }}
          rm source.zip
          rm -f response.json

      - name: Fetch Patch Script
        run: |
          # Fetch the script from the main branch since we are on 'oryx' branch (detached or specific ref)
          # We just use curl to get the raw file from the repo to ensure we have the latest logic
          curl -L "https://raw.githubusercontent.com/${{ github.repository }}/main/scripts/patch_keymap.py" -o patch_keymap.py

      - name: Apply Custom Injections
        run: |
          echo "Applying custom double tap space logic..."
          python3 patch_keymap.py "${{ github.event.inputs.layout_id }}/keymap.c"
          
      - name: Commit and Push changes
        env:
          CHANGE_DESCRIPTION: ${{ steps.download-layout-source.outputs.change_description }}
        run: |
          git config --local user.name "github-actions[bot]"
          git config --local user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "✨(oryx): $CHANGE_DESCRIPTION (with injections)" || echo "No layout change"
          git push origin oryx

      - name: Merge Oryx with custom QMK
        run: |
          git fetch origin main
          git checkout -B main origin/main
          git merge -Xignore-all-space oryx
          git push origin main

      - name: Update QMK firmware submodule
        run: |
          git submodule update --init --remote --depth=1 --no-single-branch
          cd qmk_firmware
          git remote set-url origin https://github.com/zsa/qmk_firmware.git
          git fetch origin
          
          TARGET_BRANCH="firmware${{ steps.download-layout-source.outputs.firmware_version }}"
          echo "Checking out ZSA branch: $TARGET_BRANCH"
          
          git checkout -B "$TARGET_BRANCH" "origin/$TARGET_BRANCH" || {
            echo "Branch $TARGET_BRANCH not found, falling back."
            git checkout -B firmware24 origin/firmware24 || git checkout master
          }
          
          git submodule update --init --recursive
          cd ..
          
          git add qmk_firmware
          git commit -m "✨(qmk): Update firmware to $TARGET_BRANCH" || echo "No QMK change"
          git push origin main

      - name: Create QMK Dockerfile
        run: |
          cat > Dockerfile <<'EOF'
          FROM ubuntu:22.04
          ENV DEBIAN_FRONTEND=noninteractive
          RUN apt-get update && apt-get install -y --no-install-recommends \
              ca-certificates curl git build-essential python3 python3-pip \
              gcc-arm-none-eabi binutils-arm-none-eabi dfu-util unzip \
              libnewlib-arm-none-eabi libstdc++-arm-none-eabi-newlib \
            && apt-get clean && rm -rf /var/lib/apt/lists/*
          COPY qmk_firmware/requirements.txt /tmp/requirements.txt
          RUN pip3 install --no-cache-dir qmk && \
              pip3 install --no-cache-dir -r /tmp/requirements.txt
          WORKDIR /qmk_firmware
          EOF

      - name: Build qmk docker image
        run: docker build -t qmk .

      - name: Build the layout
        id: build-layout
        run: |
          FIRMWARE_VERSION="${{ steps.download-layout-source.outputs.firmware_version }}"
          if [ "$FIRMWARE_VERSION" -ge 24 ]; then
            KEYBOARD_DIR="qmk_firmware/keyboards/zsa"
            MAKE_PREFIX="zsa/"
          else
            KEYBOARD_DIR="qmk_firmware/keyboards"
            MAKE_PREFIX=""
          fi
          
          QMK_KEYBOARD_NAME=$(echo "${{ github.event.inputs.layout_geometry }}" | cut -d'/' -f1)
          TARGET_KEYBOARD_DIR="${KEYBOARD_DIR}/${QMK_KEYBOARD_NAME}/keymaps"
          
          echo "Using keyboard directory: $TARGET_KEYBOARD_DIR"
          mkdir -p "$TARGET_KEYBOARD_DIR"
          rm -rf "${TARGET_KEYBOARD_DIR}/${{ github.event.inputs.layout_id }}"
          cp -r "${{ github.event.inputs.layout_id }}" "${TARGET_KEYBOARD_DIR}/${{ github.event.inputs.layout_id }}"

          docker run --rm -v "$(pwd)/qmk_firmware:/qmk_firmware" qmk /bin/sh -c "
            qmk setup -y -H /qmk_firmware && \
            make ${MAKE_PREFIX}${QMK_KEYBOARD_NAME}:${{ github.event.inputs.layout_id }}
          "

          NORMALIZED_GEOMETRY=$(echo "${{ github.event.inputs.layout_geometry }}" | sed 's/\//_/g')
          BUILT_FILE=$(find ./qmk_firmware -type f -regex ".*${QMK_KEYBOARD_NAME}.*\.\(bin\|hex\)" -print -quit)
          
          if [ -z "$BUILT_FILE" ]; then
             echo "::error::Build failed, artifact not found"
             exit 1
          fi

          echo "built_layout_file=${BUILT_FILE}" >> "$GITHUB_OUTPUT"
          echo "normalized_layout_geometry=${NORMALIZED_GEOMETRY}" >> "$GITHUB_OUTPUT"

      - name: Upload layout
        if: steps.build-layout.outputs.built_layout_file != ''
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.build-layout.outputs.normalized_layout_geometry }}_${{ github.event.inputs.layout_id }}
          path: ${{ steps.build-layout.outputs.built_layout_file }}
